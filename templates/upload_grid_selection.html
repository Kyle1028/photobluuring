<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/static/logo-icon.png" />
    <title>{{ _('ä¸Šå‚³åª’é«”ä¸¦é¸æ“‡å€åŸŸ') }} - {{ exhibition.title }} - å•†æ™¯ Bizeview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            /* å…¨ç«™é è¨­ç¦æ­¢ä¸€èˆ¬æ–‡å­—åç™½é¸å–ï¼ˆè¡¨å–®å…ƒç´ é™¤å¤–ï¼‰ */
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* è¡¨å–®å…ƒç´ ä»å…è¨±é¸å–æ–‡å­—ï¼Œæ–¹ä¾¿è¼¸å…¥ç·¨è¼¯ */
        input, textarea, select {
            -webkit-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .navbar-brand {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .navbar-brand a {
            text-decoration: none;
            color: inherit;
        }
        
        .navbar-brand img {
            height: 40px;
            vertical-align: middle;
        }

        /* å³ä¸Šè§’ä½¿ç”¨è€…å€å¡Šï¼ˆèˆ‡å…¶ä»–é é¢ä¸€è‡´ï¼‰ */
        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-email {
            color: #666;
            font-size: 14px;
        }

        .nav-link {
            background: #667eea;
            color: white;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        }

        .nav-link:hover {
            background: #5568d3;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px 20px;
        }
        
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 15px;
        }
        
        .floor-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .floor-selector label {
            font-weight: 600;
            color: #333;
        }
        
        .floor-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .floorplan-container {
            position: relative;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: auto;
            margin-bottom: 20px;
            max-height: 600px;
            min-height: 400px;
        }
        
        .floorplan-image {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        .floorplan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }
        
        .cell-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: auto;
        }
        
        /* æ³¨æ„ï¼šé€™è£¡çš„æ ¼å­æ˜¯ SVG <rect>ï¼Œä¸èƒ½ç”¨ background/borderï¼Œè¦ç”¨ fill/stroke */
        .cell-box {
            cursor: pointer;
            transition: all 0.2s;
            fill: rgba(102, 126, 234, 0.12);
            stroke: rgba(102, 126, 234, 0.35);
            stroke-width: 2;
        }
        
        .cell-box:hover {
            fill: rgba(102, 126, 234, 0.22);
            stroke: #667eea;
        }
        
        .cell-box.selected {
            fill: rgba(46, 204, 113, 0.30);
            stroke: #2bcc6e;
        }
        
        .cell-box.inactive {
            fill: rgba(149, 165, 166, 0.10);
            stroke: #95a5a6;
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .cell-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
            font-weight: 600;
            color: #667eea;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .selected-cells-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .selected-cells-list h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .selected-cell-tag {
            display: inline-block;
            background: #2ecc71;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin: 4px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .help-text {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 8px 10px !important;
            }

            .navbar-brand img {
                height: 28px !important;
            }

            .navbar-user {
                width: auto;
                justify-content: flex-end;
                margin-top: 0;
                gap: 6px !important;
                flex-wrap: nowrap;
            }

            .user-email {
                display: none !important;
            }

            .container {
                padding: 80px 10px 15px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">
            <a href="{{ url_for('index') }}">
                <img src="/static/logo.png" alt="å•†æ™¯ Bizeview" style="height: 40px; vertical-align: middle;">
            </a>
        </div>
        <div class="navbar-user">
            {% if current_user.is_authenticated %}
                {% include '_language_switcher.html' %}
                <span class="user-email">ğŸ‘¤ {{ current_user.username or current_user.email }}</span>
                {% include '_settings_dropdown.html' %}
            {% else %}
                {% include '_language_switcher.html' %}
                <a href="{{ url_for('auth.login') }}" class="nav-link">{{ _('ç™»å…¥') }}</a>
                <a href="{{ url_for('auth.register') }}" class="nav-link">{{ _('è¨»å†Š') }}</a>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <div class="page-header">
            <h1>{{ _('ä¸Šå‚³åª’é«”ä¸¦é¸æ“‡å€åŸŸ') }}</h1>
            <div class="floor-selector">
                <label>{{ _('é¸æ“‡æ¨“å±¤') }}ï¼š</label>
                <select id="floorSelector" onchange="changeFloor(this.value)">
                    {% for floor in floors %}
                        <option value="{{ floor.floor_code }}" {% if floor.floor_code == selected_floor.floor_code %}selected{% endif %}>
                            {{ floor.floor_code }} ({{ floor.width_meters }}m Ã— {{ floor.height_meters }}m)
                        </option>
                    {% endfor %}
                </select>
            </div>
            <p class="help-text">{{ _('é»æ“Šå¹³é¢åœ–ä¸Šçš„å€åŸŸä¾†é¸æ“‡ï¼Œå¯é¸æ“‡å¤šå€‹å€åŸŸ') }}</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="uploadForm">
            <!-- é€™è£¡æœƒç”± JS å‹•æ…‹æ’å…¥å¤šå€‹ <input name="selected_cells" value="..."> -->
            <div id="selectedCellsInputs"></div>
            
            <div class="upload-section">
                <!-- ç¸®æ”¾æ§åˆ¶ -->
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                    <button type="button" onclick="floorplanZoomIn()" style="background:#667eea;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;">ï¼‹</button>
                    <button type="button" onclick="floorplanZoomOut()" style="background:#667eea;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;">ï¼</button>
                    <button type="button" onclick="floorplanResetView()" style="background:#95a5a6;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;">{{ _('é‡ç½®') }}</button>
                    <span id="floorplanZoomLabel" style="color:#666;font-size:14px;">100%</span>
                    <span style="color:#999;font-size:12px;">{{ _('æ»‘é¼ æ»¾è¼ªç¸®æ”¾ã€æ‹–æ›³å¹³ç§»') }}</span>
                </div>
                
                <div class="floorplan-container" id="floorplanContainer">
                    <!-- èˆ‡å±•è¦½è©³æƒ…é ç›¸åŒçš„çµæ§‹ï¼šåœ–ç‰‡èˆ‡ç¶²æ ¼ä¸€èµ·æ”¾åœ¨ stage è£¡ï¼Œæ–¹ä¾¿æ•´é«”ç¸®æ”¾èˆ‡æ‹–æ›³ -->
                    <div id="floorplanStage" style="position: relative; transform-origin: 0 0; cursor: grab; touch-action: none;">
                        <img id="floorplanImage" 
                             src="{{ url_for('exhibition_floor_image', exhibition_public_id=exhibition.public_id, floor_code=selected_floor.floor_code) }}" 
                             alt="{{ selected_floor.floor_code }}"
                             style="display: block; max-width: 100%; height: auto;"
                             onload="setTimeout(() => { if(window.floorplanResetView) window.floorplanResetView(); renderCells(); }, 10);"
                             onerror="console.error('Failed to load floor plan image'); handleImageLoadError();">
                        <!-- overlay éœ€è¦å¯æ¥æ”¶é»æ“Šäº‹ä»¶ï¼ˆé»æ ¼å­é¸æ“‡ï¼‰ -->
                        <div class="floorplan-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto;">
                            <svg class="cell-grid" id="cellGrid" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: auto;"></svg>
                        </div>
                    </div>
                </div>
                
                <div class="selected-cells-list" id="selectedCellsList">
                    <h3>{{ _('å·²é¸å€åŸŸ') }} (<span id="selectedCount">0</span>)</h3>
                    <div id="selectedCellsTags"></div>
                </div>
                
                <div class="form-group">
                    <label for="mediaFile">{{ _('é¸æ“‡æª”æ¡ˆ') }} *</label>
                    <input type="file" id="mediaFile" name="media" accept="image/*,video/*" required>
                    <div class="help-text">{{ _('æ”¯æ´ç…§ç‰‡å’Œå½±ç‰‡æ ¼å¼') }}</div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        {{ _('ä¸Šå‚³') }}
                    </button>
                    <a href="{{ url_for('exhibition_detail', exhibition_public_id=exhibition.public_id) }}" class="btn btn-secondary">
                        {{ _('å–æ¶ˆ') }}
                    </a>
                </div>
            </div>
        </form>
    </div>

    <script>
        const cellsData = {{ cells | tojson }};
        const floorData = {
            code: "{{ selected_floor.floor_code }}",
            width: {{ selected_floor.width_meters }},
            height: {{ selected_floor.height_meters }},
            gridSize: {{ selected_floor.grid_size }}
        };
        
        let selectedCellIds = new Set();

        // ç¸®æ”¾/å¹³ç§»ç‹€æ…‹ï¼ˆèˆ‡å±•è¦½è©³æƒ…é ä¸€è‡´ï¼‰
        let fpScale = 1;
        let fpTx = 0;
        let fpTy = 0;
        let fpDragging = false;
        let fpLastX = 0;
        let fpLastY = 0;
        let fpMoved = false;
        let fpDownTarget = null; // è¨˜éŒ„æŒ‰ä¸‹æ™‚çš„ç›®æ¨™å…ƒç´ 
        let fpDownCellId = null; // è¨˜éŒ„æŒ‰ä¸‹æ™‚çš„æ ¼å­ ID
        let fpDownCellCode = null; // è¨˜éŒ„æŒ‰ä¸‹æ™‚çš„æ ¼å­ä»£ç¢¼
        let fpDownX = 0; // è¨˜éŒ„æŒ‰ä¸‹æ™‚çš„ X åº§æ¨™
        let fpDownY = 0; // è¨˜éŒ„æŒ‰ä¸‹æ™‚çš„ Y åº§æ¨™
        function getGridSizeFromCells() {
            // ä»¥ DB ç”¢ç”Ÿçš„ cells ç‚ºæº–ï¼ˆé¿å… width/grid_size æµ®é»èª¤å·®æˆ–ä¸åŒæ­¥ï¼‰
            const maxCol = Math.max(...cellsData.map(c => c.col));
            const maxRow = Math.max(...cellsData.map(c => c.row));
            return { cols: maxCol + 1, rows: maxRow + 1 };
        }
        
        function changeFloor(floorCode) {
            window.location.href = "{{ url_for('upload_exhibition_with_cells', exhibition_public_id=exhibition.public_id) }}?floor=" + floorCode;
        }
        
        function handleImageLoadError() {
            const img = document.getElementById('floorplanImage');
            const container = document.getElementById('floorplanContainer');
            if (img) img.style.display = 'none';
            if (container) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;">{{ _("ç„¡æ³•è¼‰å…¥å¹³é¢åœ–") }}</div>';
            }
        }

        function renderCells() {
            const img = document.getElementById('floorplanImage');
            const svg = document.getElementById('cellGrid');
            if (!img || !svg) return;

            // ç¢ºä¿åœ–ç‰‡å·²ç¶“åŠ è¼‰å®Œæˆ
            if (!img.complete || img.naturalWidth === 0) {
                console.warn('Image not loaded yet, waiting...');
                return;
            }

            // ç”¨å¯¦éš›é¡¯ç¤ºå°ºå¯¸åšåº§æ¨™ç³»ï¼Œé¿å… overlay å°ä¸é½Š/æ¯”ä¾‹æ€ª
            // æ³¨æ„ï¼šimg åœ¨ stage å…§æœƒè¢« scaleï¼›é€™è£¡è¦ç”¨ã€Œæœªç¸®æ”¾çš„åŸºæº–å°ºå¯¸ã€
            const displayWidth = Math.round(img.offsetWidth);
            const displayHeight = Math.round(img.offsetHeight);

            svg.setAttribute('viewBox', `0 0 ${displayWidth} ${displayHeight}`);
            svg.setAttribute('width', displayWidth);
            svg.setAttribute('height', displayHeight);
            svg.style.width = displayWidth + 'px';
            svg.style.height = displayHeight + 'px';

            // è¨ˆç®—ç¶²æ ¼å°ºå¯¸ï¼ˆåŸºæ–¼æ•´å€‹æ¨“å±¤ï¼‰- èˆ‡å±•è¦½è©³æƒ…é ä¸€è‡´
            const totalCols = Math.floor(floorData.width / floorData.gridSize);
            const totalRows = Math.floor(floorData.height / floorData.gridSize);
            const cellWidth = displayWidth / totalCols;
            const cellHeight = displayHeight / totalRows;
            
            // æ¸…ç©º SVG
            svg.innerHTML = '';
            
            // ç¹ªè£½æ¯å€‹å€åŸŸ
            cellsData.forEach(cell => {
                if (!cell.is_active) return; // è·³éç„¡æ•ˆå€åŸŸ
            
                const x = cell.col * cellWidth;
                const y = cell.row * cellHeight;
                const isSelected = selectedCellIds.has(cell.id);
                const hasMedia = (cell.media_count || 0) > 0;
                
                const r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                r.setAttribute('x', x);
                r.setAttribute('y', y);
                r.setAttribute('width', cellWidth);
                r.setAttribute('height', cellHeight);
                r.setAttribute('class', `cell-box ${isSelected ? 'selected' : ''}`);
                // å·²æœ‰åª’é«”çš„æ ¼å­ç”¨æ›´æ˜é¡¯é¡è‰²æç¤º
                if (hasMedia && !isSelected) {
                    r.style.fill = 'rgba(46, 204, 113, 0.18)';
                    r.style.stroke = 'rgba(46, 204, 113, 0.55)';
                }
                r.setAttribute('data-cell-id', cell.id);
                r.setAttribute('data-cell-code', cell.cell_code);
                // é¸æ“‡åŠŸèƒ½ç¾åœ¨é€šé pointerup äº‹ä»¶è™•ç†ï¼ˆåœ¨æ‹–ç§»é‚è¼¯ä¸­ï¼‰
                svg.appendChild(r);
            });
        }
        
        // å°‡ renderCells æš´éœ²åˆ°å…¨åŸŸï¼Œè®“ç¸®æ”¾å‡½æ•¸å¯ä»¥èª¿ç”¨
        window.renderCells = renderCells;

        // åˆå§‹åŒ–å¹³ç§»ï¼ç¸®æ”¾ï¼šæ”¯æ´æ»‘é¼ æ»¾è¼ªç¸®æ”¾èˆ‡æ‹–æ›³å¹³ç§»
        (function initFloorplanPanZoom() {
            const container = document.getElementById('floorplanContainer');
            const stage = document.getElementById('floorplanStage');
            if (!container || !stage) return;

            // è®“æ‰‹æ©Ÿè§¸æ§å¯ä»¥æ‹–ç§»ï¼ˆé¿å…ç€è¦½å™¨æŠŠæ‹–æ›³ç•¶æˆæ²å‹•/ç¸®æ”¾é é¢ï¼‰
            container.style.touchAction = 'none';

            function clamp(val, min, max) {
                return Math.max(min, Math.min(max, val));
            }

            function applyTransform() {
                const label = document.getElementById('floorplanZoomLabel');
                stage.style.transform = `translate(${fpTx}px, ${fpTy}px) scale(${fpScale})`;
                if (label) label.textContent = `${Math.round(fpScale * 100)}%`;
            }

            function floorplanZoomIn() {
                fpScale = clamp(fpScale * 1.05, 0.4, 4);
                applyTransform();
            }

            function floorplanZoomOut() {
                fpScale = clamp(fpScale / 1.05, 0.4, 4);
                applyTransform();
            }

            function floorplanResetView() {
                fpScale = 1;
                // ç›¡é‡å°‡å¹³é¢åœ–ç½®ä¸­é¡¯ç¤º
                const container = document.getElementById('floorplanContainer');
                const img = document.getElementById('floorplanImage');
                if (container && img) {
                    const cRect = container.getBoundingClientRect();
                    const imgWidth = img.naturalWidth || img.offsetWidth || cRect.width;
                    const imgHeight = img.naturalHeight || img.offsetHeight || cRect.height;
                    // è‹¥åœ–ç‰‡æ¯”å®¹å™¨å°ï¼Œç½®ä¸­ï¼›æ¯”å®¹å™¨å¤§å°±å¾å·¦ä¸Šé–‹å§‹
                    fpTx = imgWidth < cRect.width ? (cRect.width - imgWidth) / 2 : 0;
                    fpTy = imgHeight < cRect.height ? (cRect.height - imgHeight) / 2 : 0;
                } else {
                    fpTx = 0;
                    fpTy = 0;
                }
                applyTransform();
            }

            // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸï¼Œè®“æŒ‰éˆ•å¯ä»¥å‘¼å«
            window.floorplanZoomIn = floorplanZoomIn;
            window.floorplanZoomOut = floorplanZoomOut;
            window.floorplanResetView = floorplanResetView;

            // æ»¾è¼ªç¸®æ”¾ï¼ˆä»¥æ¸¸æ¨™ä½ç½®ç‚ºä¸­å¿ƒï¼‰ï¼Œæ¯æ¬¡ç´„ 5%
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const prevScale = fpScale;
                const dy = e.deltaY || 0;
                const step = 1.05;
                const nextScale = clamp(dy > 0 ? fpScale / step : fpScale * step, 0.4, 4);
                if (nextScale === prevScale) return;

                const rect = container.getBoundingClientRect();
                const cx = e.clientX - rect.left;
                const cy = e.clientY - rect.top;

                const sx = (cx - fpTx) / prevScale;
                const sy = (cy - fpTy) / prevScale;

                fpScale = nextScale;
                fpTx = cx - sx * fpScale;
                fpTy = cy - sy * fpScale;

                applyTransform();
            }, { passive: false });

            // æ‹–æ›³å¹³ç§»ï¼ˆæ»‘é¼ èˆ‡è§¸æ§ï¼‰- å…è¨±åœ¨ä»»ä½•åœ°æ–¹é–‹å§‹æ‹–ç§»
            stage.addEventListener('pointerdown', (e) => {
                if (e.isPrimary === false) return;
                fpMoved = false;
                fpDownTarget = e.target;
                fpDownX = e.clientX;
                fpDownY = e.clientY;
                
                // è¨˜éŒ„æ˜¯å¦é»æ“Šåœ¨æ ¼å­ä¸Šï¼ˆæª¢æŸ¥ rect å…ƒç´ æˆ–å…¶çˆ¶å…ƒç´ ï¼‰
                let target = e.target;
                let rectElement = null;
                
                // å¦‚æœé»æ“Šçš„æ˜¯ rectï¼Œç›´æ¥ä½¿ç”¨
                if (target && target.tagName && target.tagName.toLowerCase() === 'rect') {
                    rectElement = target;
                } else {
                    // å¦‚æœé»æ“Šçš„æ˜¯ SVG æˆ–å…¶ä»–å…ƒç´ ï¼Œå˜—è©¦æ‰¾åˆ°æœ€è¿‘çš„ rect çˆ¶å…ƒç´ 
                    let parent = target;
                    while (parent && parent !== stage) {
                        if (parent.tagName && parent.tagName.toLowerCase() === 'rect') {
                            rectElement = parent;
                            break;
                        }
                        parent = parent.parentElement;
                    }
                }
                
                if (rectElement) {
                    fpDownCellId = rectElement.getAttribute('data-cell-id');
                    fpDownCellCode = rectElement.getAttribute('data-cell-code');
                } else {
                    fpDownCellId = null;
                    fpDownCellCode = null;
                }
                
                // å…è¨±åœ¨ä»»ä½•åœ°æ–¹é–‹å§‹æ‹–ç§»
                fpDragging = true;
                fpLastX = e.clientX;
                fpLastY = e.clientY;
                stage.style.cursor = 'grabbing';
                try { stage.setPointerCapture(e.pointerId); } catch (_) {}
            });

            stage.addEventListener('pointermove', (e) => {
                if (!fpDragging) return;
                const dx = e.clientX - fpLastX;
                const dy = e.clientY - fpLastY;
                const moveDistance = Math.abs(dx) + Math.abs(dy);
                
                // å¦‚æœç§»å‹•è·é›¢è¶…é 5pxï¼Œè¦–ç‚ºæ‹–ç§»ä¸¦æ›´æ–°ä½ç½®
                if (moveDistance > 5) {
                    fpMoved = true;
                    fpLastX = e.clientX;
                    fpLastY = e.clientY;
                    fpTx += dx;
                    fpTy += dy;
                    applyTransform();
                }
                e.preventDefault();
            }, { passive: false });

            stage.addEventListener('pointerup', (e) => {
                if (!fpDragging) {
                    fpDownTarget = null;
                    fpDownCellId = null;
                    fpDownCellCode = null;
                    fpMoved = false;
                    return;
                }
                
                // è¨ˆç®—å¾æŒ‰ä¸‹åˆ°æ”¾é–‹çš„ç¸½ç§»å‹•è·é›¢
                const totalDx = Math.abs(e.clientX - fpDownX);
                const totalDy = Math.abs(e.clientY - fpDownY);
                const totalDistance = totalDx + totalDy;
                
                // å¦‚æœç§»å‹•è·é›¢å¾ˆå°ï¼ˆå°æ–¼ 5pxï¼‰ï¼Œä¸”é»æ“Šçš„æ˜¯æ ¼å­ï¼Œå‰‡è§¸ç™¼é¸æ“‡è€Œä¸æ˜¯æ‹–ç§»
                if (totalDistance < 5 && fpDownCellId && fpDownCellCode) {
                    // æª¢æŸ¥é»æ“Šçš„æ ¼å­æ˜¯å¦æ˜¯æœ‰æ•ˆçš„
                    const clickedCell = cellsData.find(c => c.id === parseInt(fpDownCellId));
                    if (!clickedCell || !clickedCell.is_active) {
                        // ç„¡æ•ˆçš„æ ¼å­ï¼Œä¸è™•ç†é»æ“Š
                        fpDragging = false;
                        fpDownTarget = null;
                        fpDownCellId = null;
                        fpDownCellCode = null;
                        fpMoved = false;
                        stage.style.cursor = 'grab';
                        try { stage.releasePointerCapture(e.pointerId); } catch (_) {}
                        return;
                    }
                    
                    // ç¢ºä¿é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¸ç™¼å…¶ä»–äº‹ä»¶
                    e.stopPropagation();
                    toggleCell(parseInt(fpDownCellId), fpDownCellCode);
                }
                
                fpDragging = false;
                fpDownTarget = null;
                fpDownCellId = null;
                fpDownCellCode = null;
                fpMoved = false; // é‡ç½®ç§»å‹•æ¨™è¨˜
                stage.style.cursor = 'grab';
                try { stage.releasePointerCapture(e.pointerId); } catch (_) {}
            });

            stage.addEventListener('pointercancel', (e) => {
                fpDragging = false;
                fpDownTarget = null;
                fpDownCellId = null;
                fpDownCellCode = null;
                fpMoved = false;
                stage.style.cursor = 'grab';
                try { stage.releasePointerCapture(e.pointerId); } catch (_) {}
            });

            // åˆå§‹åŒ–è¦–åœ–ï¼šå¦‚æœåœ–ç‰‡å·²ç¶“åŠ è¼‰å®Œæˆå°±ç«‹å³é‡ç½®ï¼Œå¦å‰‡ç­‰å¾… onload äº‹ä»¶
            const img = document.getElementById('floorplanImage');
            if (img && img.complete && img.naturalWidth > 0) {
                // åœ–ç‰‡å·²ç¶“åŠ è¼‰å®Œæˆ
                floorplanResetView();
            }
            // å¦‚æœåœ–ç‰‡é‚„æ²’åŠ è¼‰å®Œæˆï¼Œonload äº‹ä»¶æœƒè™•ç†é‡ç½®
        })();

        // è¦–çª—å°ºå¯¸æ”¹è®Šæ™‚é‡æ–°å°é½Š overlay ä¸¦é‡ç½®è¦–åœ–
        window.addEventListener('resize', () => {
            try {
                if (window.floorplanResetView) {
                    window.floorplanResetView();
                }
                renderCells();
            } catch (e) {}
        });
        
        function toggleCell(cellId, cellCode) {
            // æª¢æŸ¥æ ¼å­æ˜¯å¦æ˜¯æœ‰æ•ˆçš„
            const cell = cellsData.find(c => c.id === cellId);
            if (!cell || !cell.is_active) {
                // ç„¡æ•ˆçš„æ ¼å­ï¼Œä¸å…è¨±é¸æ“‡
                return;
            }
            
            if (selectedCellIds.has(cellId)) {
                selectedCellIds.delete(cellId);
            } else {
                selectedCellIds.add(cellId);
            }
            updateSelectedCells();
            
            // åªæ›´æ–°é¸æ“‡ç‹€æ…‹ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´å€‹ç¶²æ ¼ï¼Œé¿å…ç¶²æ ¼è·‘æ‰
            const svg = document.getElementById('cellGrid');
            if (svg) {
                const rects = svg.querySelectorAll('rect[data-cell-id="' + cellId + '"]');
                rects.forEach(rect => {
                    if (selectedCellIds.has(cellId)) {
                        rect.classList.add('selected');
                    } else {
                        rect.classList.remove('selected');
                    }
                });
            } else {
                // å¦‚æœ SVG ä¸å­˜åœ¨ï¼Œæ‰é‡æ–°æ¸²æŸ“
                renderCells();
            }
        }
        
        function updateSelectedCells() {
            const count = selectedCellIds.size;
            document.getElementById('selectedCount').textContent = count;
            
            const tagsDiv = document.getElementById('selectedCellsTags');
            tagsDiv.innerHTML = '';
            
            if (count === 0) {
                tagsDiv.innerHTML = '<span style="color: #999;">{{ _("å°šæœªé¸æ“‡ä»»ä½•å€åŸŸ") }}</span>';
                document.getElementById('submitBtn').disabled = true;
            } else {
                cellsData.forEach(cell => {
                    if (selectedCellIds.has(cell.id)) {
                        const tag = document.createElement('span');
                        tag.className = 'selected-cell-tag';
                        tag.textContent = cell.cell_code;
                        tagsDiv.appendChild(tag);
                    }
                });
                document.getElementById('submitBtn').disabled = false;
            }
            
            // æ›´æ–°éš±è—æ¬„ä½ï¼ˆç”¨å¤šå€‹åŒå inputï¼Œè®“å¾Œç«¯ request.form.getlist('selected_cells') å¯ç›´æ¥å–å¾—åˆ—è¡¨ï¼‰
            const inputsContainer = document.getElementById('selectedCellsInputs');
            inputsContainer.innerHTML = '';
            Array.from(selectedCellIds).forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selected_cells';
                input.value = String(id);
                inputsContainer.appendChild(input);
            });
        }
        
        // åˆå§‹åŒ–
        document.getElementById('mediaFile').addEventListener('change', function() {
            if (this.files.length > 0 && selectedCellIds.size > 0) {
                document.getElementById('submitBtn').disabled = false;
            }
        });
        
        updateSelectedCells();
    </script>
</body>
</html>
